# 🚂 Railway Deployment Guide

This guide explains how to deploy your FastAPI Traffic Management System backend to Railway.

## 🎯 Quick Start

### Step 1: Create Railway Account
1. Go to [railway.app](https://railway.app)
2. Sign up (no credit card required for free tier)
3. Create a new project

### Step 2: Deploy Backend
1. **Connect your GitHub repository** to Railway
2. **Railway will automatically detect** your `railway.toml` configuration
3. **Deploy**: Click "Deploy" button

### Step 3: Set Environment Variables
Railway will automatically generate database variables. Add these additional variables:

```bash
# JWT Configuration
SECRET_KEY=your-secure-secret-key-here
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=30

# CORS (Update with your frontend domain)
ALLOWED_ORIGINS=https://your-frontend-domain.vercel.app

# Optional: External APIs
OPENWEATHER_API_KEY=your-openweather-api-key
TOMTOM_API_KEY=your-tomtom-api-key
```

## 📋 What Railway Creates

Railway automatically provisions:

### ✅ Backend Service (`traffic-management-backend`)
- **Domain**: `https://your-app.railway.app`
- **Port**: Automatically assigned ($PORT)
- **Environment**: Python 3.11.9

### ✅ Database Service (`traffic-management-db`)
- **Type**: MySQL 8.0
- **Auto-generated credentials**:
  - `MYSQL_ROOT_PASSWORD`
  - `MYSQL_PASSWORD`
  - `MYSQL_HOST`
  - `MYSQL_PORT` (3306)
  - `MYSQL_DATABASE` (traffic_management)

## 🔧 Database Setup

### Automatic Migration
Railway will run your database migrations automatically on first deploy.

### Manual Migration (if needed)
```bash
# SSH into your Railway app
railway run alembic upgrade head
```

## 🌐 CORS Configuration

For production, update your `main.py` CORS origins:

```python
# In backend/app/main.py - Update line 38-46
allow_origins=[
    "https://your-frontend-domain.vercel.app",  # Your Vercel frontend
    "https://your-app.railway.app",              # Your Railway backend
    # Add other allowed domains
],
```

## 🔍 Health Check

Railway uses `/health` endpoint for health checks:
- ✅ **Healthy**: `{"status": "healthy"}`
- ❌ **Unhealthy**: Non-200 response

## 🚀 Deployment Commands

### Deploy from GitHub
```bash
# Railway auto-deploys on git push
git add .
git commit -m "Deploy to Railway"
git push origin main
```

### Manual Deploy
```bash
# Via Railway CLI
railway up

# Via Railway Dashboard
# Go to your project → Deployments → "Deploy Latest Commits"
```

## 📊 Monitoring

### Railway Dashboard
- **Logs**: Real-time application logs
- **Metrics**: CPU, Memory, Network usage
- **Deployments**: View deployment history
- **Variables**: Manage environment variables

### Accessing Logs
```bash
# View logs via Railway CLI
railway logs

# Or via Railway dashboard
# Project → Service → Logs tab
```

## 🔐 Environment Variables

### Railway Auto-Generated
```bash
MYSQL_ROOT_PASSWORD=<auto-generated>
MYSQL_PASSWORD=<auto-generated>
MYSQL_HOST=<your-db-host.railway.internal>
MYSQL_PORT=3306
MYSQL_DATABASE=traffic_management
```

### Custom Variables (Add via Dashboard)
```bash
SECRET_KEY=your-super-secure-secret-key
ALLOWED_ORIGINS=https://your-frontend.vercel.app
OPENWEATHER_API_KEY=your-api-key
TOMTOM_API_KEY=your-api-key
```

## 🔧 Troubleshooting

### Common Issues

#### 1. Database Connection Failed
```bash
# Check database variables in Railway dashboard
# Ensure MYSQL_HOST is correct (ends with .railway.internal)
```

#### 2. Migration Errors
```bash
# Run migrations manually
railway run alembic upgrade head

# Check current revision
railway run alembic current
```

#### 3. Port Issues
- Railway automatically assigns `$PORT`
- Your app uses `0.0.0.0:$PORT` (handled in railway.toml)

#### 4. Memory Issues (512MB limit on free tier)
```bash
# Check memory usage
railway logs | grep -i memory

# Optimize your app if needed
# - Reduce concurrent connections
# - Add pagination to large queries
```

## 💰 Pricing

### Free Tier (`Hobby`)
- ✅ **$5/month credits** (resets monthly)
- ✅ **512MB RAM** per service
- ✅ **Shared CPU**
- ✅ **1GB storage**

### Pro Tier ($20/month)
- ✅ **Unlimited projects**
- ✅ **8GB RAM** per service
- ✅ **Dedicated CPU**
- ✅ **100GB storage**

## 🔄 Updating Your App

### Automatic Updates
Railway auto-deploys when you push to your connected GitHub repo.

### Manual Updates
```bash
# Force redeploy
railway up --detach

# Or via dashboard: "Deploy Latest Commits"
```

## 🔗 Connecting to Frontend

### Update Frontend API URLs
```javascript
// In your frontend code
const API_BASE_URL = 'https://your-app.railway.app'
const WS_URL = 'wss://your-app.railway.app'
```

### CORS Headers
Railway automatically handles CORS for your domain, but ensure your FastAPI CORS configuration includes your frontend domain.

## 📞 Support

### Railway Documentation
- [Railway Docs](https://docs.railway.app)
- [Python Deployment Guide](https://docs.railway.app/deploy/python)

### Getting Help
1. **Railway Discord**: Community support
2. **Railway Status**: [status.railway.app](https://status.railway.app)
3. **Check logs** in Railway dashboard first

## 🎉 Success Checklist

- [ ] Railway account created
- [ ] GitHub repository connected
- [ ] Backend deployed successfully
- [ ] Database connected and migrated
- [ ] Environment variables configured
- [ ] Frontend API URLs updated
- [ ] CORS configured properly
- [ ] Health check returns 200 OK

---

**🎊 Your FastAPI backend is now live on Railway!**

Access your API at: `https://your-app.railway.app`

API Documentation: `https://your-app.railway.app/docs`
